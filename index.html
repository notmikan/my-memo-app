<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Perfect Dual Memo v17</title>
<style>
    :root { --bg-main:#fff; --bg-sidebar:#f7f9fb; --bg-hover:#eaeef2; --bg-active:#e0e0e0; --text:#333; --text-sec:#999; --border:#e1e4e8; --pin:#ff9800; --danger:#e81123; }
    [data-theme="dark"] { --bg-main:#1e1e1e; --bg-sidebar:#252526; --bg-hover:#2d2d2d; --bg-active:#37373d; --text:#ccc; --text-sec:#666; --border:#3e3e42; --pin:#ffb74d; }
    body { margin:0; height:100vh; display:flex; font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background:var(--bg-main); color:var(--text); overflow:hidden; }
    * { box-sizing:border-box; transition:background-color .2s, color .2s, border-color .2s; }
    button { cursor:pointer; padding:4px 8px; background:var(--bg-main); border:1px solid var(--border); color:var(--text); border-radius:4px; }
    button:hover { background:var(--bg-hover); }
    input[type="text"], input[type="search"] { background:var(--bg-main); color:var(--text); border:1px solid var(--border); padding:4px 8px; border-radius:4px; outline:none; }

    #sidebar { width:260px; min-width:260px; background:var(--bg-sidebar); border-right:1px solid var(--border); display:flex; flex-direction:column; }
    .sb-header { padding:10px; border-bottom:1px solid var(--border); display:flex; flex-direction:column; gap:8px; }
    .sb-btns { display:flex; gap:5px; }
    .sb-btns button { flex:1; font-size:12px; }
    #search-box { width:100%; padding:6px; font-size:13px; }
    #memo-list { flex:1; overflow-y:auto; padding:0; margin:0; list-style:none; }
    
    .folder-item { margin-top:5px; }
    .folder-header { padding:6px 10px; font-weight:bold; cursor:pointer; display:flex; align-items:center; gap:5px; user-select:none; color:var(--text-sec); font-size:13px; }
    .folder-header:hover { background:var(--bg-hover); color:var(--text); }
    .folder-header.drag-over { background:var(--bg-active); }
    .folder-icon { transition: transform .2s; }
    .folder-item.folded .folder-icon { transform: rotate(-90deg); }
    .folder-memos { padding-left:0; list-style:none; }
    .folder-item.folded .folder-memos { display:none; }

    .memo-item { padding:8px 10px 8px 20px; cursor:grab; border-bottom:1px solid var(--border); color:var(--text-sec); display:flex; align-items:center; gap:5px; user-select:none; font-size:14px; }
    .memo-item:hover { background:var(--bg-hover); color:var(--text); }
    .memo-item.active { background:var(--bg-active); color:var(--text); font-weight:bold; }
    .memo-item.pinned { border-left:3px solid var(--pin); padding-left:17px; background:var(--bg-hover); }
    .memo-type { font-size:12px; opacity:0.7; }
    .memo-title { flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .item-btns { display:none; gap:4px; margin-left:auto; }
    .memo-item:hover .item-btns { display:flex; }
    .ib-btn { cursor:pointer; opacity:0.5; font-size:14px; padding:2px; }
    .ib-btn:hover { opacity:1; }

    #main { flex:1; display:flex; flex-direction:column; background:var(--bg-main); min-width:0; }
    #toolbar { padding:10px 20px; border-bottom:1px solid var(--border); display:flex; gap:15px; align-items:center; font-size:13px; }
    #editor-container { flex:1; position:relative; overflow:hidden; }
    .ev { width:100%; height:100%; overflow-y:auto; display:none; outline:none; padding:30px 50px; }
    .ev.active { display:block; }
    #rich { white-space:pre-wrap; word-break:break-word; line-height:1.7; }
    #rich img { max-width:50%; height:auto; display:block; margin:10px 0; border-radius:4px; box-shadow:0 2px 8px rgba(0,0,0,.1); }
    .node { display:flex; margin-bottom:4px; }
    .nb { width:24px; height:24px; flex-shrink:0; display:flex; align-items:center; justify-content:center; cursor:pointer; color:var(--marker); }
    .nb:hover { color:var(--text); }
    .bd { width:6px; height:6px; background:currentColor; border-radius:50%; }
    .node.folded .bd { width:0; height:0; background:none; border-left:6px solid currentColor; border-top:4px solid transparent; border-bottom:4px solid transparent; }
    .ni { flex:1; min-height:24px; outline:none; border:none; background:transparent; color:var(--text); resize:none; overflow:hidden; font-family:inherit; font-size:inherit; line-height:1.5; padding:2px 0; }

    #cm { position:absolute; display:none; z-index:9999; background:var(--bg-main); border:1px solid var(--border); box-shadow:2px 2px 10px rgba(0,0,0,.2); border-radius:4px; padding:5px 0; min-width:150px; }
    .ci { padding:8px 15px; cursor:pointer; font-size:14px; display:flex; align-items:center; gap:8px; }
    .ci:hover { background:var(--bg-hover); }
    .cs { height:1px; background:var(--border); margin:4px 0; }
</style>
</head>
<body>
<nav id="sidebar">
    <div class="sb-header">
        <div class="sb-btns"><button id="bn-rich">ğŸ“„ ãƒ¡ãƒ¢</button><button id="bn-out">ğŸŒ³ ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³</button><button id="bn-fol" title="ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆ">ğŸ“+</button></div>
        <input type="search" id="search-box" placeholder="ğŸ” æ¤œç´¢...">
    </div>
    <div id="memo-list"></div>
</nav>
<main id="main">
    <div id="toolbar">
        <div style="display:flex; align-items:center; gap:5px;"><label>æ–‡å­—:</label><input type="range" id="sz" min="12" max="60" value="16"><span id="szv">16px</span></div>
        <span id="char-count" style="color:var(--text-sec); margin-left:10px;">0æ–‡å­—</span>
        <div style="flex:1;"></div>
        <button id="b-bkp" title="å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜">ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</button>
        <button id="b-rst" title="ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§å¾©å…ƒ">ğŸ“‚ å¾©å…ƒ</button>
        <input type="file" id="rst-file" style="display:none" accept=".json">
        <span style="border-left:1px solid var(--border); height:20px; margin:0 5px;"></span>
        <button id="b-exp">â¬‡ï¸ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button><button id="b-thm">ğŸŒ“ ãƒ†ãƒ¼ãƒ</button>
    </div>
    <div id="editor-container">
        <div id="rich" class="ev" contenteditable="true"></div><div id="out" class="ev"></div>
    </div>
</main>
<div id="cm"><div class="ci" id="cm-ren">âœï¸ åå‰ã‚’å¤‰æ›´</div><div class="ci" id="cm-pin">ğŸ“Œ ãƒ”ãƒ³ç•™ã‚åˆ‡æ›¿</div><div class="cs"></div><div class="ci" id="cm-del" style="color:var(--danger);">ğŸ—‘ï¸ å‰Šé™¤</div></div>

<script>
let D={memos:[],folders:[{id:'f1',name:'ãƒ¡ã‚¤ãƒ³',folded:false}],cur:null,cfg:{fs:16,th:'light'}}, drg={id:null,type:null}, ctx={id:null,type:null}, srch='';
const K='pdm_v17', E={r:document.getElementById('rich'),o:document.getElementById('out'),l:document.getElementById('memo-list'),cm:document.getElementById('cm'),cc:document.getElementById('char-count')};
function sv(){try{localStorage.setItem(K,JSON.stringify(D));}catch(e){alert('å®¹é‡ã‚ªãƒ¼ãƒãƒ¼');}}
function ld(){const d=localStorage.getItem(K);if(d){D=JSON.parse(d);if(!D.folders)D.folders=[{id:'f1',name:'ãƒ¡ã‚¤ãƒ³',folded:false}]; D.memos.forEach(m=>{if(!m.fid)m.fid='f1';});}else{cm('rich',true);}rd();op(D.cur||D.memos[0]?.id);ac();}

function cm(t,ini=false){const id=Date.now(),fid=D.folders.find(f=>!f.folded)?.id||D.folders[0].id;D.memos.unshift({id,type:t,title:'æ–°è¦'+(t==='rich'?'ãƒ¡ãƒ¢':'ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³'),html:'',nodes:t==='outline'?[{id:id+'-1',text:'',level:0,folded:false}]:undefined,pin:false,fid});if(!ini){D.cur=id;srch='';document.getElementById('search-box').value='';sv();rd();op(id);}}
function cf(){const n=prompt('ãƒ•ã‚©ãƒ«ãƒ€å:');if(n){D.folders.push({id:'f'+Date.now(),name:n,folded:false});sv();rd();}}
function dm(id){if(!confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ'))return;D.memos=D.memos.filter(m=>m.id!==id);if(D.cur===id)op(D.memos[0]?.id);sv();rd();}
function df(id){if(D.folders.length<=1){alert('å‰Šé™¤ä¸å¯');return;}if(!confirm('ãƒ•ã‚©ãƒ«ãƒ€ã¨ä¸­èº«ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ'))return;D.memos=D.memos.filter(m=>m.fid!==id);D.folders=D.folders.filter(f=>f.id!==id);if(!D.memos.find(m=>m.id===D.cur))op(D.memos[0]?.id);sv();rd();}
function op(id){D.cur=id;const m=D.memos.find(x=>x.id===id);if(!m){E.r.classList.remove('active');E.o.classList.remove('active');uc(0);return;}
    if(m.type==='rich'){E.r.classList.add('active');E.o.classList.remove('active');E.r.innerHTML=m.html||'';uc(E.r.innerText.replace(/\n/g,'').length);}
    else{E.r.classList.remove('active');E.o.classList.add('active');ro();uc(m.nodes.reduce((a,b)=>a+b.text.length,0));} rd();}
function uc(n){E.cc.textContent=n+'æ–‡å­—';} // Update Char Count

function rd(){ // Render
    E.l.innerHTML='';
    if(srch){ // æ¤œç´¢ãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ•ãƒ©ãƒƒãƒˆè¡¨ç¤ºï¼‰
        const hits=D.memos.filter(m=>(m.title+m.html+(m.nodes?m.nodes.map(n=>n.text).join(' '):'')).toLowerCase().includes(srch.toLowerCase()));
        hits.forEach(m=>E.l.appendChild(rm(m)));
    }else{ // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ•ã‚©ãƒ«ãƒ€è¡¨ç¤ºï¼‰
        D.folders.forEach(f=>{
            const fd=document.createElement('div'); fd.className=`folder-item ${f.folded?'folded':''}`;
            fd.innerHTML=`<div class="folder-header"><span class="folder-icon">â–¼</span>ğŸ“ ${esc(f.name)}</div><ul class="folder-memos"></ul>`;
            const fh=fd.querySelector('.folder-header'), fl=fd.querySelector('.folder-memos');
            fh.onclick=()=>{f.folded=!f.folded;sv();rd();}
            fh.oncontextmenu=(e)=>{e.preventDefault();ctx={id:f.id,type:'folder'};shwCm(e);}
            fh.ondragover=(e)=>{e.preventDefault();fh.classList.add('drag-over');e.dataTransfer.dropEffect='move';}
            fh.ondragleave=()=>{fh.classList.remove('drag-over');}
            fh.ondrop=(e)=>{e.preventDefault();fh.classList.remove('drag-over');if(drg.type==='memo'){const m=D.memos.find(x=>x.id===drg.id);m.fid=f.id;sv();rd();}}
            D.memos.filter(m=>m.fid===f.id).sort((a,b)=>b.pin-a.pin).forEach(m=>fl.appendChild(rm(m)));
            E.l.appendChild(fd);
        });
    }
}
function rm(m){ // Render Memo Item
    const li=document.createElement('li'); li.className=`memo-item ${m.id===D.cur?'active':''} ${m.pin?'pinned':''}`;
    li.draggable=true; li.dataset.id=m.id;
    li.innerHTML=`<span class="memo-type">${m.type==='rich'?'ğŸ“„':'ğŸŒ³'}</span><span class="memo-title">${m.pin?'ğŸ“Œ':''}${esc(m.title)}</span>
    <div class="item-btns"><span class="ib-btn pin-b">ğŸ“Œ</span><span class="ib-btn del-b" style="color:var(--danger)">âœ–</span></div>`;
    li.onclick=(e)=>{if(!e.target.closest('.ib-btn'))op(m.id);}
    li.oncontextmenu=(e)=>{e.preventDefault();ctx={id:m.id,type:'memo'};shwCm(e);}
    li.querySelector('.pin-b').onclick=(e)=>{e.stopPropagation();m.pin=!m.pin;sv();rd();}
    li.querySelector('.del-b').onclick=(e)=>{e.stopPropagation();dm(m.id);}
    li.ondragstart=(e)=>{drg={id:m.id,type:'memo'};e.dataTransfer.effectAllowed='move';}
    return li;
}
function shwCm(e){E.cm.style.display='block';E.cm.style.left=e.pageX+'px';E.cm.style.top=e.pageY+'px';document.getElementById('cm-pin').style.display=ctx.type==='folder'?'none':'flex';}
document.addEventListener('click',()=>E.cm.style.display='none');
document.getElementById('search-box').addEventListener('input',(e)=>{srch=e.target.value;rd();});

document.getElementById('cm-ren').onclick=()=>{const t=ctx.type==='memo'?D.memos.find(x=>x.id===ctx.id):D.folders.find(x=>x.id===ctx.id);const n=prompt('åå‰å¤‰æ›´:',t.title||t.name);if(n){if(ctx.type==='memo')t.title=n;else t.name=n;sv();rd();}}
document.getElementById('cm-pin').onclick=()=>{const m=D.memos.find(x=>x.id===ctx.id);m.pin=!m.pin;sv();rd();}
document.getElementById('cm-del').onclick=()=>{if(ctx.type==='memo')dm(ctx.id);else df(ctx.id);}

document.getElementById('bn-rich').onclick=()=>cm('rich'); document.getElementById('bn-out').onclick=()=>cm('outline'); document.getElementById('bn-fol').onclick=cf;
document.getElementById('b-thm').onclick=()=>{D.cfg.th=D.cfg.th==='dark'?'light':'dark';ac();sv();}
document.getElementById('sz').oninput=(e)=>{D.cfg.fs=e.target.value;ac();sv();}
document.getElementById('b-bkp').onclick=()=>{const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([JSON.stringify(D)],{type:'application/json'}));a.download='memo_backup_'+new Date().toISOString().slice(0,10)+'.json';a.click();}
document.getElementById('b-rst').onclick=()=>document.getElementById('rst-file').click();
document.getElementById('rst-file').onchange=(e)=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=(ev)=>{try{D=JSON.parse(ev.target.result);sv();ld();alert('å¾©å…ƒã—ã¾ã—ãŸ');}catch(e){alert('ãƒ•ã‚¡ã‚¤ãƒ«ãŒå£Šã‚Œã¦ã„ã¾ã™');}};r.readAsText(f);}
document.getElementById('b-exp').onclick=()=>{const m=D.memos.find(x=>x.id===D.cur);if(!m)return;let c='',t='text/plain',ex='.txt';if(m.type==='rich'){c=`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${esc(m.title)}</title></head><body>${m.html}</body></html>`;t='text/html';ex='.html';}else{m.nodes.forEach(n=>{c+='\t'.repeat(n.level)+'- '+n.text+'\n';});}const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([c],{type:t}));a.download=m.title+ex;a.click();}

E.r.addEventListener('input',()=>{const m=D.memos.find(x=>x.id===D.cur);if(m&&m.type==='rich'){m.html=E.r.innerHTML;uc(E.r.innerText.replace(/\n/g,'').length);sv();}});
E.r.addEventListener('paste',(e)=>{const it=(e.clipboardData||e.originalEvent.clipboardData).items;for(let i=0;i<it.length;i++){if(it[i].type.indexOf("image")===0){e.preventDefault();const r=new FileReader();r.onload=(ev)=>document.execCommand('insertImage',false,ev.target.result);r.readAsDataURL(it[i].getAsFile());return;}}});
function ro(){const m=D.memos.find(x=>x.id===D.cur);if(!m||m.type!=='outline')return;E.o.innerHTML='';let sk=-1;m.nodes.forEach((n,i)=>{if(sk!==-1){if(n.level>sk)return;sk=-1;}const d=document.createElement('div');d.className='node'+(n.folded?' folded':'');d.style.paddingLeft=(n.level*24)+'px';d.innerHTML=`<div class="nb"><div class="bd"></div></div><textarea class="ni" rows="1"></textarea>`;d.querySelector('.nb').onclick=()=>{const nx=m.nodes[i+1];if(nx&&nx.level>n.level){n.folded=!n.folded;sv();ro();}};const inp=d.querySelector('.ni');inp.value=n.text;inp.oninput=()=>{n.text=inp.value;ah(inp);sv();uc(m.nodes.reduce((a,b)=>a+b.text.length,0));};inp.onkeydown=(e)=>hk(e,i,n,m);E.o.appendChild(d);ah(inp);if(n.folded)sk=n.level;});}
function ah(e){e.style.height='auto';e.style.height=e.scrollHeight+'px';}
function hk(e,i,n,m){if(e.key==='Enter'&&!e.ctrlKey&&!e.metaKey&&!e.isComposing){e.preventDefault();m.nodes.splice(i+1,0,{id:Date.now()+'',text:'',level:n.level,folded:false});sv();ro();setTimeout(()=>E.o.querySelectorAll('.ni')[i+1]?.focus(),0);}if(e.key==='Backspace'&&e.target.selectionStart===0&&i>0){e.preventDefault();const p=m.nodes[i-1],l=p.text.length;p.text+=n.text;m.nodes.splice(i,1);sv();ro();setTimeout(()=>{const el=E.o.querySelectorAll('.ni')[i-1];el?.focus();el?.setSelectionRange(l,l);},0);}if(e.key==='Tab'){e.preventDefault();if(e.shiftKey){if(n.level>0)n.level--;}else{if(i>0&&n.level<=m.nodes[i-1].level)n.level++;}sv();ro();setTimeout(()=>E.o.querySelectorAll('.ni')[i]?.focus(),0);}if((e.ctrlKey||e.metaKey)&&e.key==='Enter'){e.preventDefault();const nx=m.nodes[i+1];if(nx&&nx.level>n.level){n.folded=!n.folded;sv();ro();}}}
function ac(){document.documentElement.setAttribute('data-theme',D.cfg.th);E.r.style.fontSize=E.o.style.fontSize=D.cfg.fs+'px';document.getElementById('szv').textContent=D.cfg.fs+'px';}
function esc(s){return s.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));}
ld();
</script>
</body>
</html>